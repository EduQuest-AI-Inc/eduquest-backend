# Reusable deployment template
parameters:
  - name: environment
    type: string
  - name: awsConnection
    type: string
  - name: ec2InstanceId
    type: string
  - name: stackName
    type: string
  - name: awsRegion
    type: string
    default: 'us-east-2'

steps:
  - checkout: self

  - task: DownloadPipelineArtifact@2
    displayName: 'Download artifact'
    inputs:
      buildType: 'current'
      artifactName: 'drop'
      targetPath: '$(Pipeline.Workspace)/drop'

  - task: ExtractFiles@1
    displayName: 'Extract artifact'
    inputs:
      archiveFilePatterns: '$(Pipeline.Workspace)/drop/*.zip'
      destinationFolder: '$(Pipeline.Workspace)/app'
      cleanDestinationFolder: true

  # Update CloudFormation stack
  - task: AWSShellScript@1
    displayName: 'Update API Gateway Stack'
    inputs:
      awsCredentials: ${{ parameters.awsConnection }}
      regionName: ${{ parameters.awsRegion }}
      scriptType: 'inline'
      inlineScript: |
        cd $(Pipeline.Workspace)/app/cloudformation

        STACK_NAME="${{ parameters.stackName }}"
        ENVIRONMENT="${{ parameters.environment }}"

        echo "Checking if stack exists: $STACK_NAME"

        if aws cloudformation describe-stacks --stack-name "$STACK_NAME" 2>/dev/null; then
          echo "Stack exists, updating..."
          bash $(Pipeline.Workspace)/app/scripts/update-api-gateway.sh "$ENVIRONMENT"
        else
          echo "Stack does not exist, creating..."
          bash $(Pipeline.Workspace)/app/scripts/deploy-api-gateway.sh "$ENVIRONMENT"
        fi

  # Deploy to EC2
  - task: AWSShellScript@1
    displayName: 'Deploy to EC2'
    inputs:
      awsCredentials: ${{ parameters.awsConnection }}
      regionName: ${{ parameters.awsRegion }}
      scriptType: 'inline'
      inlineScript: |
        cd $(Pipeline.Workspace)/app

        INSTANCE_ID="${{ parameters.ec2InstanceId }}"
        ENVIRONMENT="${{ parameters.environment }}"

        echo "Deploying to EC2 instance: $INSTANCE_ID"

        bash scripts/deploy-to-ec2.sh "$ENVIRONMENT" "$INSTANCE_ID"

  # Health check
  - task: AWSShellScript@1
    displayName: 'Run health check'
    inputs:
      awsCredentials: ${{ parameters.awsConnection }}
      regionName: ${{ parameters.awsRegion }}
      scriptType: 'inline'
      inlineScript: |
        STACK_NAME="${{ parameters.stackName }}"

        # Get API Gateway URL
        API_URL=$(aws cloudformation describe-stacks \
          --stack-name "$STACK_NAME" \
          --query 'Stacks[0].Outputs[?OutputKey==`APIGatewayURL`].OutputValue' \
          --output text 2>/dev/null || echo "")

        if [ -z "$API_URL" ]; then
          echo "Could not get API Gateway URL from CloudFormation"
          exit 1
        fi

        echo "Testing API at: $API_URL/helloworld"

        # Wait a moment for deployment to settle
        sleep 10

        # Test with retries
        MAX_RETRIES=5
        RETRY=0

        while [ $RETRY -lt $MAX_RETRIES ]; do
          response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/helloworld")

          if [ $response -eq 200 ]; then
            echo "Health check passed (attempt $((RETRY+1)))"
            exit 0
          else
            echo "Health check failed with status: $response (attempt $((RETRY+1)))"
            RETRY=$((RETRY+1))
            if [ $RETRY -lt $MAX_RETRIES ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          fi
        done

        echo "Health check failed after $MAX_RETRIES attempts"
        exit 1
