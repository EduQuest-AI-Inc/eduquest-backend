name: Deploy to EC2

on:
  push:
    branches:
      - production  # or your deployment branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Decode SSH key
      run: |
        echo "${{ secrets.EC2_KEY }}" | base64 -d > ec2_key.pem
        chmod 600 ec2_key.pem

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd /home/ubuntu

          if [ ! -d "eduquest-backend/.git" ]; then
            echo "Repo not found, cloning fresh..."
            git clone https://github.com/eduquest2024/eduquest-backend.git eduquest-backend
          else
            echo "Repo found, updating..."
            cd eduquest-backend
            git fetch origin
            git reset --hard origin/production
          fi

          cd eduquest-backend

          echo "Activating virtualenv..."
          source venv/bin/activate || echo "Virtualenv not found, please create it manually."

          pip install -r requirements.txt

          echo "Restarting Flask app..."
          pkill -f app.py || true
          nohup python app.py > app.log 2>&1 &

          echo "Deployment finished."
        EOF

